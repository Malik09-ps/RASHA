name: RDP-Permanent
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */8 * * *'  # Ù‡Û•Ù…ÙˆÙˆ Ù¨ Ú©Ø§ØªÚ˜Ù…ÛØ± Ø¬Ø§Ø±ÛÚ©

jobs:
  maintain-rdp:
    runs-on: windows-latest
    timeout-minutes: 480  # Ù¨ Ú©Ø§ØªÚ˜Ù…ÛØ±
    steps:
      - name: Check Existing RDP
        run: |
          # Ù¾Ø´Ú©Ù†ÛŒÙ† Ø¦Û•Ú¯Û•Ø± RDP Ù¾ÛØ´ØªØ± Ú•ÛÚ©Ø®Ø±Ø§ÙˆÛ•
          $rdpEnabled = (Get-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -ErrorAction SilentlyContinue).fDenyTSConnections
          $userExists = Get-LocalUser -Name "RDPUser" -ErrorAction SilentlyContinue
          
          if ($rdpEnabled -eq 0 -and $userExists) {
              Write-Host "âœ… RDP already configured - reusing existing setup"
              echo "REUSING_EXISTING=true" >> $env:GITHUB_ENV
          } else {
              Write-Host "ğŸ”„ Setting up new RDP configuration"
              echo "REUSING_EXISTING=false" >> $env:GITHUB_ENV
          }

      - name: Setup RDP (Only if needed)
        if: env.REUSING_EXISTING == 'false'
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          
          $password = "RDP@" + (Get-Date -Format "MMdd") + "!GitHub"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          if (Get-LocalUser -Name "RDPUser" -ErrorAction SilentlyContinue) {
              Remove-LocalUser -Name "RDPUser"
          }
          
          New-LocalUser -Name "RDPUser" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDPUser"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser"
          
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          Write-Host "âœ… New RDP configuration created"

      - name: Reuse Existing Password
        if: env.REUSING_EXISTING == 'true'
        run: |
          # Ù‡Û•Ø± ÙˆÛ•Ú© Ù¾ÛØ´ÙˆÙˆ Ù¾Ø§Ø³ÙˆÛ†Ø±Ø¯Û•Ú©Û• Ø¨Ù‡ÛÚµÛ•Ø±Û•ÙˆÛ•
          $password = "RDP@" + (Get-Date -Format "MMdd") + "!GitHub"
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          Write-Host "âœ… Using existing RDP configuration"

      - name: Maintain Tailscale Connection
        run: |
          # Ù¾Ø´Ú©Ù†ÛŒÙ† Ø¦Û•Ú¯Û•Ø± ØªÛŒÙ„Ø³Ú©Û•ÛŒÙ„ Ù¾ÛØ´ØªØ± Ø¯Ø§Ù…Û•Ø²Ø±Ø§ÙˆÛ•
          if (Test-Path "$env:ProgramFiles\Tailscale\tailscale.exe") {
              Write-Host "âœ… Tailscale already installed"
              
              # Ù¾Ø´Ú©Ù†ÛŒÙ†ÛŒ Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ Ø¦ÛØ³ØªØ§
              $currentStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json | ConvertFrom-Json
              if ($currentStatus.BackendState -eq "Running") {
                  Write-Host "âœ… Tailscale already connected"
                  $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                  echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
              } else {
                  Write-Host "ğŸ”„ Reconnecting Tailscale..."
                  & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=github-rdp-permanent
                  $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                  echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
              }
          } else {
              Write-Host "ğŸ“¥ Installing Tailscale for the first time..."
              $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
              $installerPath = "$env:TEMP\tailscale.msi"
              
              Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
              Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait -NoNewWindow
              Remove-Item $installerPath -Force
              
              Start-Sleep -Seconds 15
              & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=github-rdp-permanent
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          }

      - name: Display Permanent Connection Info
        run: |
          Write-Host "ğŸ¯ PERMANENT RDP CONNECTION"
          Write-Host "============================"
          Write-Host "ğŸŒŸ This is YOUR persistent RDP"
          Write-Host "ğŸ”— IP: $env:TAILSCALE_IP"
          Write-Host "ğŸ‘¤ User: RDPUser"
          Write-Host "ğŸ” Password: $env:RDP_PASSWORD"
          Write-Host "â° Duration: 30 DAYS"
          Write-Host "ğŸ”„ Auto-maintained every 8 hours"
          Write-Host "============================"
          
          # Ù†ÙˆÙˆØ³ÛŒÙ†ÛŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ù‡Û•Ù…ÛŒØ´Û•ÛŒÛŒ
          $permanentInfo = @"
YOUR PERMANENT RDP - 30 DAYS
=============================
This is your personal RDP connection that will
be maintained for 30 days without changes.

CONNECTION DETAILS:
IP: $env:TAILSCALE_IP
Username: RDPUser
Password: $env:RDP_PASSWORD

SETUP DATE: $(Get-Date)
EXPIRES: $((Get-Date).AddDays(30))

Note: This connection auto-restarts every 8 hours
but keeps the SAME IP and credentials.
"@
          $permanentInfo | Out-File -FilePath "C:\My_Permanent_RDP.txt" -Encoding UTF8

      - name: Maintain Permanent Session
        run: |
          $startTime = Get-Date
          $totalDuration = 30 # Ú•Û†Ú˜
          $sessionEnd = $startTime.AddMinutes(470) # Ù§ Ú©Ø§ØªÚ˜Ù…ÛØ± Ùˆ Ù¥Ù  Ø®ÙˆÙ„Û•Ú©
          
          Write-Host "ğŸ”’ MAINTAINING YOUR PERMANENT RDP"
          Write-Host "=================================="
          Write-Host "ğŸ“… Started: $startTime"
          Write-Host "â° Will maintain until: $($startTime.AddDays($totalDuration))"
          Write-Host "ğŸ”— Your IP: $env:TAILSCALE_IP"
          Write-Host "=================================="
          
          $permanentIP = $env:TAILSCALE_IP
          
          while ((Get-Date) -lt $sessionEnd) {
              $currentTime = Get-Date
              $elapsed = $currentTime - $startTime
              $daysElapsed = [math]::Round($elapsed.TotalDays, 2)
              $daysRemaining = $totalDuration - $daysElapsed
              
              # Ù¾Ø´Ú©Ù†ÛŒÙ†ÛŒ Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒ Ù‡Û•Ù…ÛŒØ´Û•ÛŒÛŒ
              try {
                  # Ù¾Ø´Ú©Ù†ÛŒÙ†ÛŒ ØªÛŒÙ„Ø³Ú©Û•ÛŒÙ„
                  $currentIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
                  if ($currentIP -ne $permanentIP) {
                      Write-Host "ğŸ”„ IP changed from $permanentIP to $currentIP"
                      $permanentIP = $currentIP
                      echo "TAILSCALE_IP=$currentIP" >> $env:GITHUB_ENV
                  }
                  
                  # Ù¾Ø´Ú©Ù†ÛŒÙ†ÛŒ RDP
                  $rdpService = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
                  if ($rdpService.Status -ne 'Running') {
                      Write-Host "ğŸ”„ Restarting RDP service to maintain your connection..."
                      Start-Service -Name "TermService"
                  }
                  
                  Write-Host "[$currentTime] ğŸ”’ YOUR RDP - Day $daysElapsed/$totalDuration - $daysRemaining days left - IP: $permanentIP"
                  
              } catch {
                  Write-Host "âš ï¸ Maintenance check: $($_.Message)"
              }
              
              Start-Sleep -Seconds 300  # Ù¥ Ø®ÙˆÙ„Û•Ú©
          }
          
          Write-Host "ğŸ”„ Your RDP will auto-restart in 10 minutes..."
